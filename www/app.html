<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MapLarge App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css">
    <link rel="stylesheet" href="/css/app.css">
    <!--
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    -->
</head>
<body>

    <section class="section">
        <article class="container">

            <div id="maplarge-app">

                <h1 class="title">Hello App!</h1>
        
                <section id="widget-1" class="widget">
                    <h2>Widget 1</h2>
                </section>
        
                <!-- ++++++++++++++++++++++++++++++++++++++++++++ -->

                <section id="widget-2" class="widget">

                    <h2 class="subtitle is-4">Widget 2</h2>

                    <article class="columns">

                        <div class="crate-navigation column">

                            <h5 class="subtitle is-5">Navigation</h6>

                            <div class="content">

                                <div class="crate-parent">
                                    <p>Parent:</p>
                                    <span class="parent"></span>
                                </div>

                                <p class="">Current: <span id="val-current"></span></p>

                                <form class="form-search">
                                    <div class="field is-grouped">
                                        <p class="control is-expanded">
                                            <input class="input" type="text" name="q" placeholder="Find a file...">
                                        </p>
                                        <p class="control">
                                            <button type="submit" class="button is-info">Search</button>
                                        </p>
                                    </div>
                                </form> 

                                <div class="children"></div> <!-- list of child nodes -->

                                <div class="search-results"></div> <!-- list of nodes -->

                                <div>
                                    <div class="root-path">
                                        Root Folder: <span class="show-val"></span> | <a href="#" class="clickme-to_edit">Edit</a>
                                    </div>
                                    <form class="form-edit_root">
                                        <label class="label">Set root path</label>
                                        <div class="field is-grouped">
                                            <p class="control is-expanded">
                                                <input class="input" type="text" name="rootpath" placeholder="Enter path...">
                                            </p>
                                            <p class="control">
                                                <button type="submit" class="button is-info">Save</button>
                                            </p>
                                        </div>
                                    </form> 
                                </div>

                            </div>

                        </div>

                        <div class="crate-info column">
                            <h5 class="subtitle is-5">Data and Ops</h5>
                            <div class="meta"></div>
                            <hr />
                            <div class="info">
                                <ul>
                                    <li>Type: <span>TBD</span></li>
                                </ul>
                            </div>
                            <hr />
                            <div>
                                <span>Upload</span>
                                <form id="form-upload_file">
                                    <label>
                                        <span>Upload File</span>
                                        <input type="file" name="file" id="file_to_upload">
                                    </label>
                                    <input type="hidden" name="foo" value="bar">
                                    <input type="submit" value="Upload">
                                </form> 
                            </div>
                        </div>
                    </article>

                </section>

                <!-- ++++++++++++++++++++++++++++++++++++++++++++ -->

                <section id="widget-3" class="widget">
                    <h2>Widget 3</h2>
                </section>
        

            </div> <!-- #maplarge-app -->

        </div> <!-- container -->
    </section>

    <!-- ======================================================= -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!--
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
-->
<script src="/js/libs/utils.js"></script>
<script src="/js/libs/Node.js"></script>
<script src="/js/libs/Navigator.js"></script>

<script type="text/javascript">

$( document ).ready(function() {


/* TEST CODE
    var fn = new FileNode(200, '/foo/bar/hello.txt', 'tmp');
    var dn = new FolderNode(10, '/foo/', 'tmp');

    console.log('here');
*/
    // ----

    // Global 'state'...
    var appConfigs = [];
    var searchResults = [];
    var navigator = new Navigator();

    function doInit() {

        // %FIXME: can they hack rootpath directly in session Storage??
        var rootpath = window.sessionStorage.getItem("rootpath");
        if ( null === rootpath ) {
            return; // do nothing...
        }

        // Otherwise load from the link in browser (deep-linking)...
        var urlParams = new URLSearchParams(window.location.search);
        var browserURL =  urlParams.has('path') ? urlParams.get('path') : rootpath; // %TODO : add comment

        navigator.setRootpath(rootpath); // NOTE rootpath is unchanged
        $('.root-path .show-val').html(navigator.rootpath);

        (function () {
            return $.ajax({
                url: '/api/index.php',
                type: 'GET',
                data: {
                    src: browserURL
                }
            })
        })()
        .then( function(response) {
            // Process response of 'index' API call 
            navigator.update(response.nodes);
            window.history.replaceState( {}, 'MapLarge App', Utils.getAppURL()+'?path='+browserURL ); // update browser URL %TODO: encasualte in function
            $('#val-current').html( navigator.renderCurrent() );
            $('.meta').html( navigator.buildMeta() );
            $('.children').html( navigator.buildChildList() );
            $('.parent').html( navigator.buildParentList() );
        });
    }
    
    // 'context' is the associated 'li' element for the node
    function doUpdate(selectedNode) {

        if ( 'file' == selectedNode.nodeType ) {
            // navigating into file
            navigator.pushFile(selectedNode);
            $('#val-current').html( navigator.renderCurrent() );
            $('form#form-upload_file input[name=dst]').val(navigator.currentNode.pathname );
            $('.meta').html( navigator.buildMeta() );
            $('.children').html( navigator.buildChildList() );
            $('.parent').html( navigator.buildParentList() );

            // %TODO; how do we know what node in the Navigator struct we clicked on from the DOM info??
            // %TODO; should be renderAsParent but pass current? how to do this?
            // => actually need to call update here, w/o going to api to get the new node list
            // %TODO: make this a link (add as method argument, and combine render...() methods into one
        } else {
            // navigating into a folder
            // %FIXME DRY

            // Call 'index' API at the current node (folder), to get updated parent folder 
            //   and child nodes (files or folders)
            (function () {
                return $.ajax({
                    url: '/api/index.php',
                    type: 'GET',
                    data: {
                        src: selectedNode.pathname
                    }
                })
            })()
            .then( function(response) {
                // Process response of 'index' API call 
                navigator.update(response.nodes);
                window.history.replaceState( {}, 'MapLarge App', Utils.getAppURL()+'?path='+navigator.currentNode.pathname ); // update browser URL %TODO: encasualte in function
                $('#val-current').html( navigator.renderCurrent() );
                $('.meta').html( navigator.buildMeta() );
                $('.children').html( navigator.buildChildList() );
                $('.parent').html( navigator.buildParentList() );
            });
        }
    }

    // $%FIXME
    $(document).on('click', '.crate-parent a.clickme_to_navigate', function(e) {
        e.preventDefault();
        var context = $(this).closest('li');
        var selectedNode = navigator.parentNode;
        doUpdate(selectedNode);
        return false;
    });

    $(document).on('click', '.children a.clickme_to_navigate', function(e) {
        e.preventDefault();
        var context = $(this).closest('li');
        //var nodeType = context.data('nodetype'); // %FIXME redundant
        var selectedNode = navigator.childNodes[context.data('guid')]; 
        doUpdate(selectedNode);
        return false;
    });

    $(document).on('click', '.search-results a.clickme_to_navigate', function(e) {
        e.preventDefault();
        var context = $(this).closest('li');
        var selectedNode = searchResults[context.data('guid')]; 
        doUpdate(selectedNode);
        return false;
    });

    // File upload
    $(document).on('submit', 'form#form-upload_file', function (e) {
        e.preventDefault();

        var thisForm = $(this);
        var formdata = new FormData(thisForm[0]);
        
        //formdata.append("CustomField", "This is some extra data, testing"); // use this and remvoe hidden field %TODO
        formdata.append("dst", navigator.currentNode.pathname);

        //$("#clickme-to_submit").prop("disabled", true);

        $.ajax({
            type: 'POST',
            url: '/api/upload.php',
            data: formdata,
            cache: false,
            contentType: false,
            processData: false,
            success: function (response) {
                $('.children').html( navigator.buildChildList() );
                //$('.parent').html( navigator.buildParentList() );
            }
        });

    });

    $(document).on('submit', 'form.form-search', function (e) {
        e.preventDefault();
        var thisForm = $(this);
        var payload = {
            q: thisForm.find('input[name="q"]').val(),
            src: navigator.currentNode.pathname
        };
        $.getJSON('/api/search.php', payload, function(response) {
            searchResults = Utils.createNodeArray(response.nodes);
            $('.search-results').html( Utils.buildSearchList(searchResults) );
        });
    });

    $(document).on('submit', 'form.form-edit_root', function (e) {
        e.preventDefault();
        var thisForm = $(this);
        // %FIXME: DRY
        $.ajax({
            url: '/api/filetype.php',
            type: 'POST',
            dataType: 'json',
            data    : thisForm.serialize(),
            success: function (response) {
                console.log('success');
                (function () {
                    return $.ajax({
                        url: '/api/index.php',
                        type: 'GET',
                        data: {
                            src: response.rootpath
                        }
                    })
                })()
                .then( function(response) {
                    // Process response of 'index' API call 
                    navigator.setRootpath(response.attrs.src); // update the rootpath
                    navigator.update(response.nodes);
                    window.sessionStorage.setItem("rootpath", navigator.rootpath);
                    window.history.replaceState( {}, 'MapLarge App', Utils.getAppURL()+'?path='+navigator.rootpath ); // update browser URL %TODO: encasualte in function
                    $('#val-current').html( navigator.renderCurrent() );
                    $('.root-path .show-val').html(navigator.rootpath);
                    $('.meta').html( navigator.buildMeta() );
                    $('.children').html( navigator.buildChildList() );
                    $('.parent').html( navigator.buildParentList() );
                });
            }
        });

    });

    doInit();



});
</script>

</body>
</html>
