<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>MapLarge App</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
</head>
<body>

    <div id="maplarge-app">

        <h1>Hello App!</h1>

        <div id="widget-1">
            <h2>Widget 1</h2>
        </div>

        <div id="widget-2">
            <h2>Widget 2</h2>
        </div>

        <div id="widget-3">
            <h2>Widget 3</h2>
            <h3>Current: <span id="val-current"></span></h3>
            <div>
                <span>Upload</span>
                <form id="form-upload_file">
                    <label>
                        <span>Upload File</span>
                        <input type="file" name="file" id="file_to_upload">
                    </label>
                    <input type="hidden" name="dst" value="">
                    <input type="submit" value="Submit" id="clickme_to_submit"/>
                </form> 
            </div>
            <ul class="children">
            </ul>
        </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="/js/libs/utils.js"></script>

<script type="text/javascript">

$( document ).ready(function() {

    var appConfigs = Array;
    var current = null;

    // First call server to get 'home'...

    function doInit() {
        (function () {
            return $.ajax({
                url: '/api/constants.php',
                type: 'GET'
            })
        })()
        .then( function(response) {
            var urlParams = new URLSearchParams(window.location.search);
            appConfigs = response.configs; // set 'global'
            if ( urlParams.has('path') ) {
                current = urlParams.get('path');
            } else {
                current = appConfigs.home;
            }
            $('#val-current').html(current);
            $('form#form-upload_file input[name=dst]').val(current);
            return $.ajax({
                url: '/api/index.php',
                type: 'GET',
                data: {
                    src: current
                }
            })
        })
        .then( function(response) {
            var parsed;
            var r;
            var list = $("#maplarge-app ul.children");
            console.log("App Configs");
            console.log(appConfigs);
            list.empty();
            parentNode = Utils.findParentNode(response.nodes);
            parsed = Utils.parseRelativePath(appConfigs.basepath, parentNode.pathname);
            list.append('<li>' + Utils.renderLink( 'parent', parsed ) + '</li>');
            for (var i = 0; i < response.nodes.length; i++) {
                r = response.nodes[i];
                if (r.is_parent_path || r.is_self_path) {
                    continue;
                }
                //list.append('<li>'+response.nodes[i].pathname+'</li>');
                parsed = Utils.parseRelativePath(appConfigs.basepath, r.pathname);
                //list.append('<li>' + Utils.renderLink( parsed, response.nodes[i].pathname ) + '</li>');
                list.append('<li>' + Utils.renderLink( parsed, parsed ) + '</li>');
                console.log('parsed: '+parsed);
            }
        });
    } // doInit()

    $(document).on('click', 'ul.children li a', function(e) {
        var context = $(this);
        e.preventDefault();
        console.log('clicked');
        current = context.data('subpath');
        $('#val-current').html(current);
        $('form#form-upload_file input[name=dst]').val(current);
        (function () {
            var url = '/api/index.php';
            return $.ajax({
                url: url,
                type: 'GET',
                data: {
                    src: current
                }
            })
        })()
        .then( function(response) {
            var parsed;
            var r;
            var list = $("#maplarge-app ul.children");
            window.history.replaceState( {}, 'MapLarge App', Utils.getAppURL()+'?path='+current ); // update browser URL %TODO: encasualte in function
            list.empty();
            parentNode = Utils.findParentNode(response.nodes);
            parsed = Utils.parseRelativePath(appConfigs.basepath, parentNode.pathname);
            list.append('<li>' + Utils.renderLink( 'parent', parsed ) + '</li>');
            for (var i = 0; i < response.nodes.length; i++) {
                r = response.nodes[i];
                if (r.is_parent_path || r.is_self_path) {
                    continue;
                }
                parsed = Utils.parseRelativePath(appConfigs.basepath, r.pathname);
                list.append('<li>' + Utils.renderLink( parsed, parsed ) + '</li>');
                console.log('parsed: '+parsed);
            }
        })
        return false;
    });

    // File upload
    $(document).on('submit', 'form#form-upload_file', function (e) {
        e.preventDefault();

        var thisForm = $(this);
        var formdata = new FormData(thisForm[0]);
        
        //formdata.append("CustomField", "This is some extra data, testing"); // use this and remvoe hidden field %TODO

        //$("#clickme_to_submit").prop("disabled", true);

        $.ajax({
            type: 'POST',
            url: '/api/upload.php',
            data: formdata,
            cache: false,
            contentType: false,
            processData: false,
            //timeout: 600000,
            success: function (response) {
            },
            error: function (e) {
            }
        });

    });

    doInit();


    /*
    (function () {
        return $.ajax({
            url: '/api/index.php',
            type: 'GET',
            data: {
                src: "/treeroot/foo"
            }
        })
    })()
    .then( function(response) {
        var list = $("#maplarge-app ul.children");
        for (var i = 0; i < response.nodes.length; i++) {
            list.append('<li>'+response.nodes[i].pathname+'</li>');
        }
    })
    .fail( function(errResponse) {
        console.log('ERROR: ...');
    });
    */

});
</script>

</body>
</html>
